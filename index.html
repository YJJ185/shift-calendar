<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>排班日历 - 智能排班规律管理</title>
    <meta name="description" content="根据你的排班规律自动生成日历视图，支持白班、夜班、休息等多种班次类型">
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="排班日历">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🗓️</text></svg>">
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div class="app-container">
        <!-- 头部 -->
        <header class="header">
            <div class="header-left">
                <span class="logo">🗓️</span>
                <h1>排班日历</h1>
            </div>
            <div class="header-right">
                <div class="theme-selector" id="themeSelector">
                    <button class="btn btn-icon-only" id="themeToggleBtn" title="切换主题">
                        <span id="themeIcon">🎨</span>
                    </button>
                    <div class="theme-menu">
                        <button class="theme-option" data-theme="dark">
                            <span class="theme-color-dot"
                                style="background: linear-gradient(135deg, #6366f1, #a855f7)"></span>
                            深色
                        </button>
                        <button class="theme-option" data-theme="light">
                            <span class="theme-color-dot"
                                style="background: linear-gradient(135deg, #f8fafc, #e2e8f0)"></span>
                            亮色
                        </button>
                        <button class="theme-option" data-theme="ocean">
                            <span class="theme-color-dot"
                                style="background: linear-gradient(135deg, #0ea5e9, #06b6d4)"></span>
                            深海蓝
                        </button>
                        <button class="theme-option" data-theme="forest">
                            <span class="theme-color-dot"
                                style="background: linear-gradient(135deg, #10b981, #059669)"></span>
                            护眼绿
                        </button>
                        <button class="theme-option" data-theme="sakura">
                            <span class="theme-color-dot"
                                style="background: linear-gradient(135deg, #ec4899, #db2777)"></span>
                            樱花粉
                        </button>
                    </div>
                </div>
                <div class="dropdown" id="exportDropdown">
                    <button class="btn btn-icon-only" id="exportBtn" title="导出">
                        📤
                    </button>
                    <div class="dropdown-menu" id="exportMenu">
                        <button class="dropdown-item" id="exportImageBtn">
                            <span>🖼️</span> 导出为图片
                        </button>
                        <button class="dropdown-item" id="exportJsonBtn">
                            <span>💾</span> 导出数据备份
                        </button>
                        <button class="dropdown-item" id="importJsonBtn">
                            <span>📂</span> 导入数据
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" id="printBtn">
                            <span>🖨️</span> 打印
                        </button>
                    </div>
                </div>
                <button class="btn btn-icon-only" id="historyBtn" title="历史记录">
                    📋
                </button>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 移动端侧边栏遮罩 -->
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            <!-- 侧边栏 -->
            <aside class="sidebar">
                <!-- Tab导航 -->
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="schedule">📅 排班</button>
                    <button class="sidebar-tab" data-tab="stats">📊 统计</button>
                    <button class="sidebar-tab" data-tab="settings">⚙️ 设置</button>
                </div>

                <!-- Tab内容区 -->
                <div class="sidebar-content">
                    <!-- 排班Tab -->
                    <div class="tab-pane active" id="tabSchedule">
                        <!-- 班次类型管理（可折叠） -->
                        <section class="card collapsible collapsed" id="shiftTypesCard">
                            <div class="card-header collapsible-header">
                                <h2>📌 班次类型 <span class="collapse-hint">(点击展开)</span></h2>
                                <div class="header-actions">
                                    <button class="btn btn-icon-only" id="addShiftTypeBtn" title="添加班次">+</button>
                                    <span class="collapse-icon">▼</span>
                                </div>
                            </div>
                            <div class="card-body collapsible-body">
                                <div class="shift-types-list" id="shiftTypesList">
                                    <!-- 动态生成 -->
                                </div>
                            </div>
                        </section>

                        <!-- 排班规律设置 -->
                        <section class="card">
                            <div class="card-header">
                                <h2>排班规律</h2>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="startDate">起始日期</label>
                                    <input type="date" id="startDate" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="startShift">今天是规律中的第几天 <span class="hint">(选择起始日期当天对应的班次)</span></label>
                                    <select id="startShift" class="form-select">
                                        <!-- 动态生成 -->
                                    </select>
                                    <div class="schedule-preview" id="schedulePreview">
                                        <!-- 显示接下来几天的排班预览 -->
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>规律设置 <span class="hint">(点击添加到规律)</span></label>
                                    <div class="pattern-builder" id="patternBuilder">
                                        <!-- 动态生成可点击的班次按钮 -->
                                    </div>
                                    <div class="pattern-preview" id="patternPreview">
                                        <span class="empty-hint">点击上方班次添加规律...</span>
                                    </div>
                                    <button class="btn btn-text" id="clearPatternBtn">清空规律</button>
                                </div>

                                <!-- 医护排班特殊规则 -->
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="weekendRestMode">
                                        <span>周末非值班自动休息</span>
                                    </label>
                                    <div class="field-hint">开启后，周六日只要没排"值班"，就自动休息</div>
                                </div>

                                <div class="form-group">
                                    <label for="scheduleName">方案名称</label>
                                    <input type="text" id="scheduleName" class="form-input" placeholder="例如：2026年1月排班">
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- 统计Tab -->
                    <div class="tab-pane" id="tabStats">
                        <!-- 倒计时卡片 -->
                        <section class="card countdown-card">
                            <div class="card-body">
                                <div class="countdown-display" id="countdownDisplay">
                                    <div class="countdown-label">距离下一个休息日</div>
                                    <div class="countdown-value" id="countdownValue">--</div>
                                    <div class="countdown-days">天</div>
                                </div>
                                <div class="countdown-next" id="countdownNext">
                                    <!-- 动态显示下一个休息日是哪天 -->
                                </div>
                            </div>
                        </section>

                        <!-- 统计卡片 -->
                        <section class="card">
                            <div class="card-header">
                                <h2>本月统计</h2>
                            </div>
                            <div class="card-body">
                                <div class="stats-grid" id="statsGrid">
                                    <div class="stats-empty">生成排班后即可查看统计</div>
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- 设置Tab -->
                    <div class="tab-pane" id="tabSettings">
                        <!-- 重要日期 & 待办 -->
                        <section class="card">
                            <div class="card-header">
                                <h2>重要日期 & 待办</h2>
                                <button class="btn btn-icon-only" id="addImportantDateBtn" title="添加">+</button>
                            </div>
                            <div class="card-body">
                                <div class="important-dates-list" id="importantDatesList">
                                    <div class="empty-hint">点击 + 添加生日、纪念日等</div>
                                </div>
                            </div>
                        </section>
                    </div>

                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 12px;">
                        <p>当前版本: v2.0.0 (Latest)</p>
                        <p id="buildTime">Build: 2026-01-28 18:30</p>
                    </div>
                </div>
    </div>

    <!-- 固定底部操作区 -->
    <div class="sidebar-footer">
        <button class="btn btn-primary btn-full" id="generateBtn">
            <span class="btn-icon">✨</span>
            生成排班
        </button>
    </div>
    </aside>

    <!-- 日历区域 -->
    <section class="calendar-section">
        <!-- 日历控制栏 -->
        <div class="calendar-controls">
            <div class="range-selector">
                <span class="label">显示范围：</span>
                <div class="btn-group" id="rangeSelector">
                    <button class="btn btn-range active" data-months="1">1个月</button>
                    <button class="btn btn-range" data-months="3">3个月</button>
                    <button class="btn btn-range" data-months="6">6个月</button>
                    <button class="btn btn-range" data-months="12">1年</button>
                </div>
            </div>
            <div class="calendar-nav">
                <button class="btn btn-nav" id="prevBtn">◀</button>
                <div class="date-picker">
                    <select id="yearSelect" class="form-select date-select">
                        <!-- 动态生成年份选项 -->
                    </select>
                    <span class="date-separator">年</span>
                    <select id="monthSelect" class="form-select date-select">
                        <option value="0">1月</option>
                        <option value="1">2月</option>
                        <option value="2">3月</option>
                        <option value="3">4月</option>
                        <option value="4">5月</option>
                        <option value="5">6月</option>
                        <option value="6">7月</option>
                        <option value="7">8月</option>
                        <option value="8">9月</option>
                        <option value="9">10月</option>
                        <option value="10">11月</option>
                        <option value="11">12月</option>
                    </select>
                    <button class="btn btn-secondary btn-today" id="todayBtn">今天</button>
                </div>
                <button class="btn btn-nav" id="nextBtn">▶</button>
            </div>
        </div>

        <!-- 日历容器 -->
        <div class="calendar-container" id="calendarContainer">
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">📅</div>
                <h3>还没有排班</h3>
                <p>在左侧设置你的班次类型和排班规律，然后点击"生成排班"</p>
            </div>
        </div>
    </section>
    </main>

    <!-- 历史记录弹窗 -->
    <div class="modal" id="historyModal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>历史排班记录</h2>
                <button class="btn btn-icon-only modal-close" id="closeHistoryBtn">×</button>
            </div>
            <div class="modal-body">
                <div class="history-list" id="historyList">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 班次类型编辑弹窗 -->
    <div class="modal" id="shiftTypeModal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 id="shiftTypeModalTitle">添加班次类型</h2>
                <button class="btn btn-icon-only modal-close" id="closeShiftTypeBtn">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="shiftTypeName">班次名称</label>
                    <input type="text" id="shiftTypeName" class="form-input" placeholder="例如：白班">
                </div>
                <div class="form-group">
                    <label for="shiftTypeIcon">图标</label>
                    <input type="text" id="shiftTypeIcon" class="form-input" placeholder="例如：☀️">
                    <div class="icon-suggestions">
                        <span class="icon-btn" data-icon="☀️">☀️</span>
                        <span class="icon-btn" data-icon="🌙">🌙</span>
                        <span class="icon-btn" data-icon="🌅">🌅</span>
                        <span class="icon-btn" data-icon="🏠">🏠</span>
                        <span class="icon-btn" data-icon="💼">💼</span>
                        <span class="icon-btn" data-icon="🌃">🌃</span>
                        <span class="icon-btn" data-icon="⭐">⭐</span>
                        <span class="icon-btn" data-icon="🔄">🔄</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="shiftTypeColor">颜色</label>
                    <div class="color-picker-wrap">
                        <input type="color" id="shiftTypeColor" class="form-color" value="#FFB74D">
                        <span class="color-value" id="colorValue">#FFB74D</span>
                    </div>
                    <div class="color-suggestions">
                        <span class="color-btn" data-color="#FFB74D" style="background:#FFB74D"></span>
                        <span class="color-btn" data-color="#7986CB" style="background:#7986CB"></span>
                        <span class="color-btn" data-color="#81C784" style="background:#81C784"></span>
                        <span class="color-btn" data-color="#FF8A65" style="background:#FF8A65"></span>
                        <span class="color-btn" data-color="#4FC3F7" style="background:#4FC3F7"></span>
                        <span class="color-btn" data-color="#BA68C8" style="background:#BA68C8"></span>
                        <span class="color-btn" data-color="#F06292" style="background:#F06292"></span>
                        <span class="color-btn" data-color="#90A4AE" style="background:#90A4AE"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="deleteShiftTypeBtn">删除</button>
                <button class="btn btn-primary" id="saveShiftTypeBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 编辑班次弹窗 -->
    <div class="modal" id="editShiftModal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 id="editShiftTitle">编辑班次</h2>
                <button class="btn btn-icon-only modal-close" id="closeEditShiftBtn">×</button>
            </div>
            <div class="modal-body">
                <p class="modal-subtitle" id="editShiftDate">2026-01-01</p>
                <div class="shift-selection-grid" id="editShiftGrid">
                    <!-- 动态生成可选班次 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="resetShiftBtn">恢复默认</button>
            </div>
        </div>
    </div>

    <!-- 确认删除对话框 -->
    <div class="modal" id="confirmModal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>确认删除</h2>
                <button class="btn btn-icon-only modal-close" id="closeConfirmBtn">×</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">确定要删除这个方案吗？</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="confirmCancelBtn">取消</button>
                <button class="btn btn-danger" id="confirmOkBtn">删除</button>
            </div>
        </div>
    </div>

    <!-- 日期编辑弹窗（调班/备注） -->
    <div class="modal" id="dayEditModal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 id="dayEditTitle">编辑日期</h2>
                <button class="btn btn-icon-only modal-close" id="closeDayEditBtn">×</button>
            </div>
            <div class="modal-body">
                <div class="day-edit-date" id="dayEditDate">
                    <!-- 显示日期信息 -->
                </div>
                <div class="form-group">
                    <label>选择班次</label>
                    <div class="day-edit-shifts" id="dayEditShifts">
                        <!-- 动态生成班次选项 -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="dayNote">备注</label>
                    <input type="text" id="dayNote" class="form-input" placeholder="添加备注（可选）">
                </div>
                <div class="form-group">
                    <label for="dayTodo">待办事项</label>
                    <input type="text" id="dayTodo" class="form-input" placeholder="添加待办事项（可选）">
                </div>
                <div class="day-edit-info">
                    <label class="checkbox-label">
                        <input type="checkbox" id="dayEditOverride">
                        <span>临时调班（仅修改这一天，不影响排班规律）</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-text" id="clearDayOverrideBtn">恢复默认</button>
                <button class="btn btn-primary" id="saveDayEditBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 重要日期弹窗 -->
    <div class="modal" id="importantDateModal">
        <div class="modal-overlay"></div>
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 id="importantDateModalTitle">添加重要日期</h2>
                <button class="btn btn-icon-only modal-close" id="closeImportantDateBtn">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="importantDateDate">日期</label>
                    <input type="date" id="importantDateDate" class="form-input">
                </div>
                <div class="form-group">
                    <label for="importantDateName">名称</label>
                    <input type="text" id="importantDateName" class="form-input" placeholder="例如：妈妈生日">
                </div>
                <div class="form-group">
                    <label for="importantDateIcon">图标</label>
                    <div class="icon-suggestions">
                        <span class="icon-btn" data-icon="🎂">🎂</span>
                        <span class="icon-btn" data-icon="💕">💕</span>
                        <span class="icon-btn" data-icon="🎉">🎉</span>
                        <span class="icon-btn" data-icon="💍">💍</span>
                        <span class="icon-btn" data-icon="🎁">🎁</span>
                        <span class="icon-btn" data-icon="📅">📅</span>
                        <span class="icon-btn" data-icon="⭐">⭐</span>
                        <span class="icon-btn" data-icon="❤️">❤️</span>
                    </div>
                    <input type="text" id="importantDateIcon" class="form-input" value="🎂"
                        style="width: 60px; text-align: center; margin-top: 8px;">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="importantDateRepeat" checked>
                        <span>每年重复</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="deleteImportantDateBtn" style="display: none;">删除</button>
                <button class="btn btn-primary" id="saveImportantDateBtn">保存</button>
            </div>
        </div>
    </div>

    <!-- 隐藏的文件导入input -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <!-- Toast 提示 -->
    <div class="toast" id="toast"></div>

    <!-- 悬停预览卡片 -->
    <div class="day-preview-card" id="dayPreviewCard">
        <div class="day-preview-header">
            <span class="day-preview-date" id="previewDate"></span>
            <span class="day-preview-weekday" id="previewWeekday"></span>
        </div>
        <div class="day-preview-lunar" id="previewLunar"></div>
        <div class="day-preview-shift" id="previewShift"></div>
        <div class="day-preview-info" id="previewInfo"></div>
    </div>

    <!-- 移动端底部导航栏 -->
    <nav class="mobile-bottom-nav">
        <div class="mobile-bottom-nav-inner">
            <button class="mobile-nav-item" id="mobileNavToday">
                <span class="mobile-nav-icon">📅</span>
                <span class="mobile-nav-label">今天</span>
            </button>
            <button class="mobile-nav-item" id="mobileNavGenerate">
                <span class="mobile-nav-icon">✨</span>
                <span class="mobile-nav-label">生成</span>
            </button>
            <button class="mobile-nav-item" id="mobileNavHistory">
                <span class="mobile-nav-icon">📋</span>
                <span class="mobile-nav-label">历史</span>
            </button>
            <button class="mobile-nav-item" id="mobileNavExport">
                <span class="mobile-nav-icon">📤</span>
                <span class="mobile-nav-label">导出</span>
            </button>
        </div>
    </nav>
    </div>

    <script src="app.js"></script>
    <script>
        // 注册 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // 添加版本号 query param 以强制更新
                navigator.serviceWorker.register('./sw.js?v=6')
                    .then(reg => {
                        console.log('Service Worker 注册成功');
                        // 发现更新时强制刷新
                        reg.onupdatefound = () => {
                            const installingWorker = reg.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // 新内容可用，提示用户
                                        console.log('New content is available; please refresh.');
                                        if (confirm('发现新版本，是否立即刷新更新？')) {
                                            window.location.reload();
                                        }
                                    }
                                }
                            };
                        };
                    })
                    .catch(err => console.log('Service Worker 注册失败:', err));
            });
        }
    </script>
</body>

</html>